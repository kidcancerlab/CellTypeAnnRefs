---
title: "Human Osteosarcoma Primary - Annotate Tumor Cells"
subtitle: "Cell type annotation reference assembly"
output: html_document
---

This script takes the output files from Primary-CreateData script (comb.qs)
and the Primary-Cluster script (selection.rds) to evaluate intratumoral
heterogeneity and to characterize tumor cell subclusters.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dev = "svg",
  fig.width = 4,
  fig.height = 4,
  fig.asp = NULL
)

library(rrrSingleCellUtils)
library(Seurat)
library(ggplot2)
library(ggrepel)
library(tidyverse)
library(stringr)
library(harmony)
library(cowplot)
library(ggpubr)

set.seed(888)

sysfonts::font_add("Arial Narrow", "ARIALN.TTF", bold = "ARIALNB.TTF")
showtext::showtext_auto()

theme_set(theme_pubr())

plot_cols <- c("#D43F3AFF", "#EEA236FF", "#357EBDFF", "#5CB85CFF", "#B8B8B8FF",
  "#9632B8FF",  "#46B8DAFF", "#90302DFF", "#A66D04FF", "#2D577FFF", "#3E7E3EFF",
  "#7D7D7DFF", "#6D1D87FF", "#097F9AFF", "#FF6E6AFF", "#FFBB70FF", "#68A4E3FF",
  "#79D379FF", "#CDCDCDFF", "#BF6BE2FF", "#69D1F3FF")

rDimPlot <- function(object, title = "Unlabeled Plot",
  label = T, pt.size = 1, ...) {
  if(length(levels(Idents(object))) < 22) {
    p <- Seurat::DimPlot(
      object = object, 
      label = label, 
      pt.size = pt.size,
      cols = alpha(plot_cols, 0.6),
      ...) +
      ggtitle(title) +
      theme(legend.position = "none") +
      coord_fixed()
    print(p)
    return(p)
  } else {
    print("Too many identity classes to use this function. Requires <22.")
  }
}

rFeaturePlot <- function(object, features, title, pt.size = 1, order = T, ...) {
  p <- Seurat::FeaturePlot(
    object = object,
    features = features,
    pt.size = pt.size,
    order = order,
    cols = (c("lightgoldenrod", "darkred")),
    ...) +
    ggtitle(title) +
    coord_fixed()
  print(p)
  return(p)
}
```

# Isolate and subcluster the tumor cells

```{r, fig.width = 8, fig.width = 8}
# Isolate the tumor cells away from the comb Seurat object
selection <- readRDS("HuOsteo/selection.rds")
tumor <- subset(qs::qread("HuOsteo/comb.qs"), cells = selection)

# Normalize and scale tumor dataset
tumor <- tumor %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA(verbose = F)

# Run batch-correction/integration using harmony
tumor <- RunHarmony(tumor, group.by.vars = "src")
tumor <- tumor %>%
  RunUMAP(reduction = "harmony", dims = 1:20) %>%
  FindNeighbors(reduction = "harmony", dims = 1:20)

plot <- list()
opt <- tribble(
  ~res, ~score, ~clusters
)

for(i in 1:9) {
  opt[i, "res"] <- 0.1 * i
  tumor <- FindClusters(tumor, resolution = opt$res[i])
  plot[[i]] <- rDimPlot(tumor, paste("Resolution", opt$res[i]))
  opt[i, "score"] <- silhouette_mean(silhouette_seurat(tumor))
  opt[i, "clusters"] <- length(levels(tumor$seurat_clusters))
}

plot_grid(plotlist = plot, ncol = 3)

# Manually enforcing a resolution of 0.2 based on review of clusters
# and potential DEGs. Silhouette performs poorly for scoring intratumor
# heterogeneity.
tumor <- FindClusters(tumor, resolution = 0.2)
clusters <- levels(factor(tumor$seurat_clusters))
names(clusters) <- paste0("Cluster", clusters)
```

# Generate DEG lists for each cluster using a pseudobulk procedure

First, generate DEG tables from pseudobulk clusters, treating all cells
from each cluster from each sample as independent groups of cells/data.
Then, graph each of those DEG datasets using a volcano plot.

```{r}
# Create pseudobulk tables
pseudobulk <- data.frame(gene = rownames(tumor@assays$RNA@counts))
rownames(pseudobulk) <- pseudobulk$gene

for(s in levels(as_factor(tumor$src))) {
  subtumor <- subset(tumor, subset = src == s)
  for(c in clusters) {
    if(length(which(subtumor$seurat_clusters == c)) > 9) {
      subclust <- subset (subtumor, seurat_clusters == c)
      lab <- paste0(s, "-C", c)
      pseudobulk[lab] <- rowSums(subclust@assays$RNA@counts)
    } else {
      print(paste("NOTE: Cluster", c, "from sample", s,
        "has less than 10 cells. This cluster will be skipped."))
    }
  }
}
pseudobulk <- pseudobulk[, -1]

# Create a separate column data table as required for generating DESeq2 input
coldata <- data.frame(sample = colnames(pseudobulk))
rownames(coldata) <- coldata$sample
coldata <- separate(coldata, "sample", c("sample", "cluster"), sep = "-C")
coldata$type <- "single-read"
coldata <- coldata[, -1]

# Perform differential expression analysis between clusters
ds2 <- list()
plots <- list()
for(c in clusters) {
  cluster_name <- names(clusters[clusters == c])

  coldata_targeted <- coldata
  coldata_targeted["cluster"][coldata_targeted["cluster"] == c] <- "target"
  coldata_targeted["cluster"][coldata_targeted["cluster"] != "target"] <- "other"

  ds2[[cluster_name]]$data_sets <- DESeq2::DESeqDataSetFromMatrix(
    countData = pseudobulk,
    colData = coldata_targeted,
    design = ~ cluster
  )

  ds2[[cluster_name]]$tests <- DESeq2::DESeq(ds2[[cluster_name]]$data_sets)
  ds2[[cluster_name]]$results <-
    as.data.frame(DESeq2::results(ds2[[cluster_name]]$tests))

  ds2[[cluster_name]]$results <-
    ds2[[cluster_name]]$results[complete.cases(ds2[[cluster_name]]$results), ]
  ds2[[cluster_name]]$results <-
    ds2[[cluster_name]]$results[order(-abs(ds2[[cluster_name]]$results$log2FoldChange)), ]
  lab <- head(ds2[[cluster_name]]$results, n = 15)

  plots[[cluster_name]][["pb_ds2"]]$volcano <-
    ggplot(ds2[[cluster_name]]$results, aes(log2FoldChange, -log10(padj))) +
      geom_point() +
      geom_label_repel(data = lab,
        aes(label = rownames(lab)),
        max.overlaps = 20) +
      ggtitle(paste("Cluster", i, "genes"))
}
```

# Perform GSEA using GO terms for BP, MP, and CC using pseudobulk DESeq2 DEGs

Identify pathways associated with changes in groups of those genes and plot results.

```{r}
for(c in clusters) {
  cluster_name <- names(clusters[clusters == c])

  ds2[[cluster_name]]$results <-
    ds2[[cluster_name]]$results[order(-ds2[[cluster_name]]$results$log2FoldChange), ]

  degs <- as.vector(ds2[[cluster_name]]$results$log2FoldChange)
  names(degs) <- rownames(ds2[[cluster_name]]$results)

  ego <- clusterProfiler::gseGO(
    geneList = degs,
    OrgDb = org.Hs.eg.db::org.Hs.eg.db,
    ont = "BP",
    keyType = "SYMBOL",
    nPermSimple = 10000,
    eps = 0
  )

  ego <- mutate(ego, p.adjust = -log10(p.adjust))

  plots[[cluster_name]]$pb_ds2$GO_BP <- enrichplot::dotplot(ego,
    x = "NES",
    showCategory = 15) +
    ggtitle(paste("GO BioProcesses - cluster", i))

  ego <- clusterProfiler::gseGO(
    geneList = degs,
    OrgDb = org.Hs.eg.db::org.Hs.eg.db,
    ont = "MF",
    keyType = "SYMBOL",
    nPermSimple = 10000,
    eps = 0
  )

  ego <- mutate(ego, p.adjust = -log10(p.adjust))

  plots[[cluster_name]]$pb_ds2$GO_MF <- enrichplot::dotplot(ego,
    x = "NES",
    showCategory = 15) +
    ggtitle(paste("GO MolFunction - cluster", i))

  ego <- clusterProfiler::gseGO(
    geneList = degs,
    OrgDb = org.Hs.eg.db::org.Hs.eg.db,
    ont = "CC",
    keyType = "SYMBOL",
    nPermSimple = 10000,
    eps = 0
  )

  ego <- mutate(ego, p.adjust = -log10(p.adjust))

  plots[[cluster_name]]$pb_ds2$GO_CC <- enrichplot::dotplot(ego,
    x = "NES",
    showCategory = 15) +
    ggtitle(paste("GO CellComponent - cluster", i))
}
```

# Generate DEG lists and volcano plots using Seurat-Wilcox DE analysis
```{r}
Idents(tumor) <- tumor$seurat_clusters
wilcox <- list()
for(c in clusters) {
  cluster_name <- names(clusters[clusters == c])

  wilcox[[cluster_name]]$results <- FindMarkers(tumor, ident.1 = c) %>%
    arrange(-abs(avg_log2FC))
  labs <- head(wilcox[[cluster_name]]$results, n = 15)

  plots[[cluster_name]][["wilcox"]]$volcano <-
    ggplot(wilcox[[cluster_name]]$results, aes(avg_log2FC, -log10(p_val_adj))) +
      geom_point() +
      geom_label_repel(data = lab,
        aes(label = rownames(lab)),
        max.overlaps = 20) +
      ggtitle(paste("Cluster", i, "genes"))
}
```

# Perform GSEA on the DEGs from the Seurat-Wilcox DE analysis

```{r}

```



# Generate plots for presenation/publication

```{r}
ggsave("HuOsteo/Plots/tumor-cluster-res-grid.png",
  plot_grid(plotlist = plot, ncol = 3),
  height = 10, width = 10, dpi = 96,
  bg = "white",
  device = agg_png
)


png(filename = "HuOsteo/Plots/tumor-cluster-res-grid.png",
  height = 10,
  width = 10,
  units = "in",
  pointsize = 4,
  type = "cairo-png",
  bg = "white",
  res = 96
)
print(plot_grid(plotlist = plot, ncol = 3))
dev.off()

png(filename = "HuOsteo/Plots/tumor-src-grid.png",
  height = 1200,
  width = 1200,
  type = "cairo"
)
print(rDimPlot(tumor, "Subclustered tumor cells", split.by = "src", ncol = 4))
dev.off()

ggsave("HuOsteo/Plots/tumor-clusters.png",
  rDimPlot(tumor, "Subclustered tumor cells"),
  height = 4,
  width = 4,
  dpi = 300,
  bg = "white"
)


png(filename = "HuOsteo/Plots/tumor-clusters.png",
  height = 450,
  width = 450,
  type = "cairo"
)
print(rDimPlot(tumor, "Subclustered tumor cells"))
dev.off()

png(filename = "HuOsteo/Plots/tumor-cluster-res-grid.png",
  height = 450,
  width = 450,
  type = "cairo"
)
print(rDimPlot(tumor, "Sublustered tumor cells - cell cycle", group.by = "Phase"))
dev.off()

for(i in unique(coldata$cluster)) {
  png(filename = paste0("HuOsteo/Plots/volcano-pseudob-tumor-clust-", i, ".png"),
    width = 600,
    height = 360,
    type = "cairo"
  )
  print(p1[[i]])
  dev.off()
}

for(i in unique(coldata$cluster)) {
  png(filename = paste0("HuOsteo/Plots/gseadot-pseudob-tumor-clust-", i, ".png"),
    width = 1500, 
    height = 600,
    type = "cairo"
  )
  print(p2[[i]])
  dev.off()
}

rDimPlot(tumor, "Subclustered tumor cells")

rDimPlot(tumor, "Subclustered tumor cells", split.by = "src", ncol = 4)

tumor <- kill_cc(tumor)
rDimPlot(tumor, "Sublustered tumor cells - cell cycle", group.by = "Phase")

```